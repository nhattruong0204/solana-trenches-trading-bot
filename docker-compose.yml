# ==============================================================================
# Solana Trading Bot - Docker Compose Configuration
# ==============================================================================

services:
  # PostgreSQL Database for Signal PnL History
  postgres:
    image: postgres:16-alpine
    container_name: solana-trading-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: wallet_tracker
    
    volumes:
      - solana-trading-bot_postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    
    networks:
      - trading-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    
    container_name: solana-trading-bot
    restart: unless-stopped
    
    # Wait for postgres to be ready
    depends_on:
      postgres:
        condition: service_healthy
    
    # Mount volumes for persistence
    volumes:
      # Data directory for state, logs, and session file
      - ./data:/app/data
    
    # Environment file
    env_file:
      - .env
    
    # Override environment variables if needed
    environment:
      - TELEGRAM_SESSION_NAME=wallet_tracker_session
      - SESSION_FILE=/app/data/wallet_tracker_session
      - STATE_FILE=/app/data/trading_state.json
      - LOG_FILE=/app/data/trading_bot.log
      - SUBSCRIPTIONS_FILE=/app/data/subscriptions.json
      - HIT_RATE_FILE=/app/data/hit_rate.json
      - KOL_TRACKER_FILE=/app/data/kol_tracker.json
      # Database connection - use 'postgres' service name
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_DATABASE=wallet_tracker
    
    # Command line arguments (optional)
    # command: ["--verbose"]
    
    # Resource limits (adjust based on your VPS specs)
    deploy:
      resources:
        limits:
          cpus: '1.0'      # Increase if you have more CPU
          memory: 512M     # Increase for better performance
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    
    # Network configuration
    networks:
      - trading-network
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: false

networks:
  trading-network:
    driver: bridge

volumes:
  solana-trading-bot_postgres_data:
    external: true
